#! /bin/bash

set -e

BOOKMARK="${1:-trunk()}"

OLD_COMMIT=`jj -R $JJ_WORKSPACE_ROOT log --ignore-working-copy -r "${BOOKMARK}" --no-graph -T 'commit_id'`
jj -R $JJ_WORKSPACE_ROOT git fetch
NEW_COMMIT=`jj -R $JJ_WORKSPACE_ROOT log --ignore-working-copy -r "${BOOKMARK}" --no-graph -T 'commit_id'`

if [ "$OLD_COMMIT" == "$NEW_COMMIT" ]; then
  exit
fi

CHANGES=`jj -R $JJ_WORKSPACE_ROOT log --ignore-working-copy -r "${OLD_COMMIT}+ & mutable()" --no-graph -T 'change_id'`

if [ -z "$CHANGES" ]; then
  exit
fi

jj -R $JJ_WORKSPACE_ROOT rebase --skip-emptied -s "${OLD_COMMIT}+ & mutable()" --onto ${BOOKMARK}
